<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.lhiot.mall.wholesale.user.mapper.UserMapper">

    <sql id="userInfo">
        id,phone,shop_name,user_name,city,address_detail,register_time,balance,profile_photo
    </sql>

    <select id="search"  parameterType="java.util.List" resultType="com.lhiot.mall.wholesale.user.domain.User">
        SELECT ID,SHOP_NAME,USER_NAME,PHONE,REGISTER_TIME,CITY,ADDRESS_DETAIL FROM T_WHS_USER WHERE id IN
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <update id="updateUserStatus" parameterType="long">
        UPDATE t_whs_user SET user_status = 1
        WHERE id = #{id}
    </update>

    <select id="user"  parameterType="long" resultType="com.lhiot.mall.wholesale.user.domain.User">
        select <include refid="userInfo" /> from t_whs_user where id=#{0}
    </select>

    <!-- 用户欠款金额-->
    <select id="debtFee"  parameterType="long" resultType="Integer">
        select IFNULL(SUM(payable_fee),0) debtFee from t_whs_order
        where user_id=#{0} and order_status in
        ('undelivery','delivery','received','unrefunded','refundfailed')
        and settlement_type='cod' and pay_status='unpaid'
    </select>

    <update id="updateUser" parameterType="com.lhiot.mall.wholesale.user.domain.User">
        UPDATE t_whs_user
        <trim prefix="set" prefixOverrides=",">
            <if test="shopName !=null and shopName !=''">
                ,shop_name=#{shopName}
            </if>
            <if test="userName !=null and userName !=''">
                ,user_name=#{userName}
            </if>
            <if test="city !=null and city !=''">
                ,city=#{city}
            </if>
            <if test="addressDetail !=null and addressDetail !=''">
                ,address_detail=#{addressDetail}
            </if>
            <if test="phone !=null and phone !=''">
                ,phone=#{phone}
            </if>
            <if test="registerTime !=null and registerTime !=''">
                ,register_time=#{registerTime}
            </if>
            <if test="balance !=null and balance !=0">
                ,balance=balance+#{balance}
            </if>
        </trim>
        where id=#{id}
    </update>

    <!-- 新增地址 -->
    <insert id="insertAddress" parameterType="com.lhiot.mall.wholesale.user.domain.UserAddress">
        insert into t_whs_user_address(
        <trim suffixOverrides=",">
            <if test="sex != null and sex != ''">sex,</if>
            <if test="phone != null and phone != ''">phone,</if>
            <if test="addressArea != null and addressArea != ''">address_area,</if>
            <if test="addressDetail != null and addressDetail != ''">address_detail,</if>
            <if test="isDefault != null">is_default,</if>
            <if test="userId != null and userId != ''">user_id,</if>
        </trim>
        )
        values(
        <trim suffixOverrides=",">
            <if test="sex != null and sex != ''">#{sex},</if>
            <if test="phone != null and phone != ''">#{phone},</if>
            <if test="addressArea != null and addressArea != ''">#{addressArea},</if>
            <if test="addressDetail != null and addressDetail != ''">#{addressDetail},</if>
            <if test="isDefault != null">#{isDefault},</if>
            <if test="userId != null and userId != ''">#{userId},</if>
        </trim>
        )
    </insert>

    <!-- 修改地址 -->
    <update id="updateAddress" parameterType="com.lhiot.mall.wholesale.user.domain.UserAddress">
        UPDATE t_whs_user_address
        <trim prefix="set" prefixOverrides=",">
            <if test="sex !=null and sex !=''">
                ,sex=#{sex}
            </if>
            <if test="phone !=null and phone !=''">
                ,phone=#{phone}
            </if>
            <if test="addressArea !=null and addressArea !=''">
                ,address_area=#{addressArea}
            </if>
            <if test="addressDetail !=null and addressDetail !=''">
                ,address_detail=#{addressDetail}
            </if>
            <if test="isDefault !=null">
                ,is_default=#{isDefault}
            </if>
            <if test="userId !=null and userId !=''">
                ,user_id=#{userId}
            </if>
        </trim>
        where id=#{id}
    </update>

    <!-- 查询当前用户所有地址 -->
    <select id="searchAddressList"  parameterType="long" resultType="com.lhiot.mall.wholesale.user.domain.UserAddress">
        select a.*,u.user_name from t_whs_user_address a
        LEFT JOIN t_whs_user u on a.user_id=u.id
        where a.user_id=#{userId} ORDER BY a.id desc
    </select>

    <select id="searchAddressListYes"  parameterType="long" resultType="com.lhiot.mall.wholesale.user.domain.UserAddress">
        select a.*,u.user_name from t_whs_user_address a
        LEFT JOIN t_whs_user u on a.user_id=u.id
        where a.user_id=#{userId} and is_default='yes'
    </select>

    <select id="searchAddressListNo"  parameterType="long" resultType="com.lhiot.mall.wholesale.user.domain.UserAddress">
        select a.*,u.user_name from t_whs_user_address a
        LEFT JOIN t_whs_user u on a.user_id=u.id
        where a.user_id=#{userId} and is_default='no' ORDER BY a.id desc
    </select>

    <!-- 查询地址 -->
    <select id="userAddress"  parameterType="long" resultType="com.lhiot.mall.wholesale.user.domain.UserAddress">
        select a.id,a.sex,a.phone,a.address_area,a.address_detail,a.user_id,u.user_name from t_whs_user_address a
        LEFT JOIN t_whs_user u on a.user_id=u.id
        where a.id=#{id}
    </select>

    <!-- 删除地址 -->
    <delete id="deleteAddress" parameterType="long">
        DELETE FROM t_whs_user_address WHERE id = #{0}
    </delete>

    <update id="updateDefaultAddress" parameterType="long">
        UPDATE t_whs_user_address SET is_default = 'no'
        WHERE is_default = 'yes' and user_id = #{0}
    </update>


    <!-- 后台管理 根据用户手机号或用户名分页查询用户信息 -->
    <select id="searchByPhoneOrName" parameterType="com.lhiot.mall.wholesale.user.domain.User"
            resultType="com.lhiot.mall.wholesale.user.domain.User">
        select <include refid="userInfo"/>
        from t_whs_user
        <trim prefix="where" prefixOverrides="and">
            <if test="namePhone != null and namePhone != ''">and user_name like CONCAT('%',#{namePhone},'%') or phone like CONCAT('%',#{namePhone},'%')</if>
            <if test="phone != null and phone != ''">and  phone like CONCAT('%',#{phone},'%')</if>
            <if test="userName != null and userName != ''">and user_name like CONCAT('%',#{userName},'%') </if>
            <if test="shopName != null and shopName != ''">and shop_name like CONCAT('%',#{shopName},'%') </if>
        </trim>
    </select>
	
	<!-- 批量发券 -->
	<select id="searchByPhones" parameterType="java.util.List" resultType="com.lhiot.mall.wholesale.user.domain.User">
		select * from t_whs_user
		where phone in
		<foreach collection="list" item = "item" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>

    <select id="searchByIds" parameterType="java.util.List" resultType="com.lhiot.mall.wholesale.user.domain.User">
        select * from t_whs_user
        where id in
        <foreach collection="list" item = "item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

	<!-- 根据手机号模糊查询用户信息 -->
	<select id="fuzzySearchByPhone" parameterType="String" resultType="com.lhiot.mall.wholesale.user.domain.User">
		select * from t_whs_user
		where phone like concat('%',#{0},'%')
	</select>
	
	<!-- 根据手机号模糊查询用户信息 -->
	<select id="searchInbatch" parameterType="java.util.List" resultType="com.lhiot.mall.wholesale.user.domain.User">
		select * from t_whs_user
		where id in
		<foreach collection="list" item = "item" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>

    <select id="getBalanceRecord" parameterType="Integer" resultType="com.lhiot.mall.wholesale.pay.domain.Balance">
        (select payment_time time,payment_from type,total_fee fee from t_whs_payment_log where user_id=#{id} )
          union all
        (select refund_time time,refund_type type,refund_fee fee from t_whs_refund_log where user_id=#{id})
    </select>
</mapper>